<!DOCTYPE html>
<html>
<head>
    <title>Pomfret School - Building Data Extractor</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        #map {
            width: 100%;
            height: 500px;
            border: 2px solid #333;
            margin: 20px 0;
        }
        button {
            background: #333;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #555;
        }
        #output {
            background: #f5f5f5;
            padding: 15px;
            border: 1px solid #ccc;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <h1>Pomfret School Building Data Extractor</h1>

    <div class="info">
        <strong>Instructions:</strong>
        <ol>
            <li>The map shows Pomfret School campus (adjust the view if needed)</li>
            <li>Click "Fetch Building Data" to query OpenStreetMap</li>
            <li>Copy the generated data below</li>
            <li>Use it in the Turtletoy code</li>
        </ol>
    </div>

    <div id="map"></div>

    <button onclick="fetchBuildings()">Fetch Building Data from OpenStreetMap</button>
    <button onclick="copyToClipboard()">Copy Data to Clipboard</button>

    <h3>Extracted Building Data:</h3>
    <div id="output">Click "Fetch Building Data" to begin...</div>

    <script>
        // Approximate center of Pomfret School campus
        const centerLat = 41.8925;
        const centerLon = -71.9680;

        // Initialize map
        const map = L.map('map').setView([centerLat, centerLon], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add a marker for the center
        L.marker([centerLat, centerLon]).addTo(map)
            .bindPopup('Pomfret School<br>Approximate Center')
            .openPopup();

        let buildingData = null;

        async function fetchBuildings() {
            const output = document.getElementById('output');
            output.textContent = 'Fetching data from OpenStreetMap...';

            // Define bounding box (approximately 500 acres / 2 km²)
            const bbox = {
                south: centerLat - 0.015,
                west: centerLon - 0.020,
                north: centerLat + 0.015,
                east: centerLon + 0.020
            };

            // Overpass API query for buildings
            const query = `
                [out:json][timeout:25];
                (
                  way["building"](${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                  relation["building"](${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                );
                out body;
                >;
                out skel qt;
            `;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();

                // Process the data
                const buildings = processOSMData(data);
                buildingData = buildings;

                // Display formatted output
                output.textContent = `// Pomfret School Building Data\n// Total buildings: ${buildings.length}\n\n`;
                output.textContent += 'const buildingData = ' + JSON.stringify(buildings, null, 2) + ';';

                // Draw buildings on map
                drawBuildingsOnMap(buildings);

                output.textContent += '\n\n// Ready to copy! Use this data in your Turtletoy code.';

            } catch (error) {
                output.textContent = 'Error fetching data: ' + error.message +
                    '\n\nNote: If CORS error occurs, you may need to run this through a local server or use the data I provide.';
            }
        }

        function processOSMData(data) {
            const nodes = {};
            const buildings = [];

            // First pass: collect all nodes
            data.elements.forEach(el => {
                if (el.type === 'node') {
                    nodes[el.id] = { lat: el.lat, lon: el.lon };
                }
            });

            // Second pass: build polygons
            data.elements.forEach(el => {
                if (el.type === 'way' && el.tags && el.tags.building) {
                    const coords = el.nodes.map(nodeId => {
                        const node = nodes[nodeId];
                        if (node) {
                            return [node.lon, node.lat];
                        }
                        return null;
                    }).filter(c => c !== null);

                    if (coords.length > 0) {
                        buildings.push({
                            type: el.tags.building,
                            name: el.tags.name || 'Building',
                            coordinates: coords
                        });
                    }
                }
            });

            return buildings;
        }

        function drawBuildingsOnMap(buildings) {
            buildings.forEach(building => {
                const coords = building.coordinates.map(c => [c[1], c[0]]); // Leaflet uses [lat, lon]
                L.polygon(coords, {
                    color: '#333',
                    weight: 2,
                    fillColor: '#666',
                    fillOpacity: 0.3
                }).addTo(map).bindPopup(building.name || building.type);
            });
        }

        function copyToClipboard() {
            const output = document.getElementById('output');
            navigator.clipboard.writeText(output.textContent).then(() => {
                alert('Data copied to clipboard!');
            });
        }
    </script>
</body>
</html>
